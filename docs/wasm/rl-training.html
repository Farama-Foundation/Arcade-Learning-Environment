<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALE WASM - RL Training Example</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        .container {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #58a6ff;
            border-bottom: 2px solid #58a6ff;
            padding-bottom: 10px;
        }
        .layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .control-panel {
            background: #21262d;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
        }
        .training-panel {
            background: #21262d;
            padding: 20px;
            border-radius: 8px;
        }
        .section {
            margin-bottom: 25px;
        }
        .section h3 {
            color: #58a6ff;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            transition: all 0.3s;
            font-weight: 600;
        }
        button.primary {
            background: #238636;
            color: white;
        }
        button.primary:hover:not(:disabled) {
            background: #2ea043;
        }
        button.secondary {
            background: #1f6feb;
            color: white;
        }
        button.secondary:hover:not(:disabled) {
            background: #388bfd;
        }
        button.danger {
            background: #da3633;
            color: white;
        }
        button.danger:hover:not(:disabled) {
            background: #f85149;
        }
        button:disabled {
            background: #373e47;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .stat-box {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .stat-box strong {
            display: block;
            color: #8b949e;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .stat-box .value {
            font-size: 1.8em;
            color: #58a6ff;
            font-weight: bold;
        }
        .chart-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            height: 300px;
            position: relative;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: monospace;
            border: 1px solid;
        }
        .status.loading {
            background: #1f2937;
            border-color: #f59e0b;
            color: #fbbf24;
        }
        .status.success {
            background: #1f2937;
            border-color: #10b981;
            color: #34d399;
        }
        .status.error {
            background: #1f2937;
            border-color: #ef4444;
            color: #f87171;
        }
        .status.training {
            background: #1f2937;
            border-color: #3b82f6;
            color: #60a5fa;
        }
        .file-input-wrapper {
            display: block;
            margin: 10px 0;
        }
        .file-input-label {
            display: block;
            padding: 10px;
            background: #238636;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
        }
        .file-input-label:hover {
            background: #2ea043;
        }
        input[type="file"] {
            display: none;
        }
        label {
            display: block;
            margin: 12px 0;
            color: #c9d1d9;
        }
        input[type="number"], select {
            width: 100%;
            padding: 8px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            margin-top: 5px;
        }
        .log-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-entry.info {
            color: #58a6ff;
        }
        .log-entry.success {
            color: #3fb950;
        }
        .log-entry.warning {
            color: #d29922;
        }
        .log-entry.error {
            color: #f85149;
        }
        .metric-label {
            display: inline-block;
            background: #21262d;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ ALE WASM - Reinforcement Learning Training</h1>

        <div id="status" class="status loading">Initializing ALE WASM...</div>

        <div class="layout">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="section">
                    <h3>üìÅ ROM Selection</h3>
                    <select id="romSelect" disabled style="width: 100%; padding: 10px; font-size: 14px; border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: #c9d1d9; margin-bottom: 10px;">
                        <option value="">-- Select a ROM --</option>
                    </select>
                    <button id="loadRomBtn" class="primary" disabled style="width: 100%; margin-bottom: 10px;">Load Selected ROM</button>
                    <div style="text-align: center; color: #8b949e; margin: 10px 0;">or</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="romFile" accept=".bin,.a26" disabled>
                        <label for="romFile" class="file-input-label">Upload ROM File</label>
                    </div>
                    <div id="romName" style="color: #8b949e; font-size: 0.9em; margin-top: 5px;">
                        No ROM loaded
                    </div>
                </div>

                <div class="section">
                    <h3>‚öôÔ∏è Training Parameters</h3>
                    <label>
                        Number of Episodes:
                        <input type="number" id="numEpisodes" value="100" min="1" max="10000">
                    </label>
                    <label>
                        Max Steps per Episode:
                        <input type="number" id="maxSteps" value="10000" min="100" max="100000">
                    </label>
                    <label>
                        Epsilon (Exploration):
                        <input type="number" id="epsilon" value="0.1" min="0" max="1" step="0.01">
                    </label>
                    <label>
                        Render Speed (FPS):
                        <input type="number" id="renderFPS" value="0" min="0" max="60">
                        <small style="color: #8b949e;">0 = no rendering (faster)</small>
                    </label>
                </div>

                <div class="section">
                    <h3>üéÆ Control</h3>
                    <button id="startBtn" class="primary" disabled>‚ñ∂ Start Training</button>
                    <button id="stopBtn" class="danger" disabled>‚èπ Stop</button>
                    <button id="resetBtn" class="secondary" disabled>üîÑ Reset Stats</button>
                </div>

                <div class="section">
                    <h3>üìä Current Episode</h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <strong>Episode</strong>
                            <div class="value" id="currentEpisode">0</div>
                        </div>
                        <div class="stat-box">
                            <strong>Steps</strong>
                            <div class="value" id="currentSteps">0</div>
                        </div>
                        <div class="stat-box">
                            <strong>Reward</strong>
                            <div class="value" id="currentReward">0</div>
                        </div>
                        <div class="stat-box">
                            <strong>Lives</strong>
                            <div class="value" id="currentLives">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Panel -->
            <div class="training-panel">
                <div class="section">
                    <h3>üìà Training Progress</h3>
                    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="stat-box">
                            <strong>Total Episodes</strong>
                            <div class="value" id="totalEpisodes">0</div>
                        </div>
                        <div class="stat-box">
                            <strong>Avg Reward</strong>
                            <div class="value" id="avgReward">0.0</div>
                        </div>
                        <div class="stat-box">
                            <strong>Max Reward</strong>
                            <div class="value" id="maxReward">0</div>
                        </div>
                        <div class="stat-box">
                            <strong>Avg Steps</strong>
                            <div class="value" id="avgSteps">0</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>üìä Reward Chart</h3>
                    <div class="chart-container">
                        <canvas id="rewardChart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <h3>üìù Training Log</h3>
                    <div class="log-container" id="logContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="ale.js"></script>
    <script>
        // createALEModule is available as a global after loading ale.js

        let ALE, ale;
        let isTraining = false;
        let minimalActions = [];

        // Training stats
        let episodes = [];
        let currentEpisodeData = { episode: 0, reward: 0, steps: 0 };
        let totalEpisodes = 0;

        const statusDiv = document.getElementById('status');
        const romFileInput = document.getElementById('romFile');
        const romSelect = document.getElementById('romSelect');
        const loadRomBtn = document.getElementById('loadRomBtn');
        const logContainer = document.getElementById('logContainer');

        // Chart
        const chartCanvas = document.getElementById('rewardChart');
        const chartCtx = chartCanvas.getContext('2d');

        function updateStatus(message, type = 'loading') {
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        // Populate ROM dropdown from preloaded ROMs in virtual filesystem
        function populateRomList() {
            try {
                const files = ALE.FS.readdir('/roms');
                const roms = files.filter(f => f !== '.' && f !== '..' && f.endsWith('.bin'))
                                  .sort();

                if (roms.length > 0) {
                    romSelect.innerHTML = '<option value="">-- Select a ROM (' + roms.length + ' available) --</option>';
                    roms.forEach(rom => {
                        const option = document.createElement('option');
                        option.value = '/roms/' + rom;
                        const displayName = rom.replace('.bin', '')
                                               .replace(/_/g, ' ')
                                               .replace(/\b\w/g, c => c.toUpperCase());
                        option.textContent = displayName;
                        romSelect.appendChild(option);
                    });
                    romSelect.disabled = false;
                    loadRomBtn.disabled = false;
                    log(`Found ${roms.length} preloaded ROMs`, 'info');
                } else {
                    romSelect.innerHTML = '<option value="">No preloaded ROMs found</option>';
                    log('No ROMs found in /roms directory', 'warning');
                }
            } catch (e) {
                romSelect.innerHTML = '<option value="">No preloaded ROMs (WASM_PRELOAD_ROMS=OFF)</option>';
                log('ROMs not preloaded in build', 'warning');
            }
        }

        // Common ROM loading logic
        function onRomLoaded(romName) {
            minimalActions = ale.getMinimalActionSet();

            updateStatus(`ROM loaded: ${romName}. Ready to train!`, 'success');
            log(`ROM loaded successfully. ${minimalActions.length} actions available.`, 'success');
            document.getElementById('romName').textContent = romName;

            // Enable controls
            document.getElementById('startBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
        }

        // Initialize ALE
        async function initALE() {
            try {
                updateStatus('Loading ALE WASM module...', 'loading');
                log('Initializing ALE WASM module...', 'info');

                ALE = await createALEModule();
                ale = new ALE.ALEInterface();

                // Configure for training
                ale.setBool('display_screen', false);
                ale.setBool('sound', false);
                ale.setFloat('repeat_action_probability', 0.0);

                // Populate ROM dropdown
                populateRomList();

                updateStatus(`ALE ${ALE.ALEInterface.getVersion()} ready. Select a ROM to begin.`, 'success');
                log(`ALE version ${ALE.ALEInterface.getVersion()} loaded successfully`, 'success');
                romFileInput.disabled = false;

            } catch (error) {
                console.error('Failed to initialize ALE:', error);
                updateStatus(`Error: ${error.message}`, 'error');
                log(`Error initializing ALE: ${error.message}`, 'error');
            }
        }

        // Handle preloaded ROM selection
        loadRomBtn.addEventListener('click', () => {
            const romPath = romSelect.value;
            if (!romPath) {
                updateStatus('Please select a ROM first', 'error');
                return;
            }

            updateStatus('Loading ROM...', 'loading');
            const displayName = romSelect.options[romSelect.selectedIndex].textContent;
            log(`Loading ROM: ${displayName}`, 'info');

            try {
                ale.loadROM(romPath);
                onRomLoaded(displayName);
            } catch (error) {
                console.error('Failed to load ROM:', error);
                updateStatus(`Error loading ROM: ${error.message}`, 'error');
                log(`Error loading ROM: ${error.message}`, 'error');
            }
        });

        romSelect.addEventListener('dblclick', () => {
            if (romSelect.value) {
                loadRomBtn.click();
            }
        });

        // Load ROM from file upload
        romFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            updateStatus('Loading ROM...', 'loading');
            log(`Loading ROM: ${file.name}`, 'info');

            try {
                await ale.loadROMFromFile(file);
                onRomLoaded(file.name);
            } catch (error) {
                console.error('Failed to load ROM:', error);
                updateStatus(`Error loading ROM: ${error.message}`, 'error');
                log(`Error loading ROM: ${error.message}`, 'error');
            }
        });

        // Random policy (epsilon-greedy with random actions)
        function selectAction(epsilon) {
            if (Math.random() < epsilon) {
                // Random exploration
                return minimalActions[Math.floor(Math.random() * minimalActions.length)];
            } else {
                // For this demo, still random (in real RL, this would be the learned policy)
                return minimalActions[Math.floor(Math.random() * minimalActions.length)];
            }
        }

        // Run single episode
        async function runEpisode(episodeNum, maxSteps, epsilon, renderFPS) {
            ale.resetGame();
            let totalReward = 0;
            let steps = 0;

            while (!ale.gameOver() && steps < maxSteps) {
                // Select and execute action
                const action = selectAction(epsilon);
                const reward = ale.act(action);
                totalReward += reward;
                steps++;

                // Update display
                if (steps % 10 === 0) {
                    document.getElementById('currentEpisode').textContent = episodeNum;
                    document.getElementById('currentSteps').textContent = steps;
                    document.getElementById('currentReward').textContent = totalReward;
                    document.getElementById('currentLives').textContent = ale.lives();
                }

                // Render delay if requested
                if (renderFPS > 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000 / renderFPS));
                }

                // Check if training stopped
                if (!isTraining) break;
            }

            return { episode: episodeNum, reward: totalReward, steps: steps };
        }

        // Training loop
        async function trainLoop() {
            const numEpisodes = parseInt(document.getElementById('numEpisodes').value);
            const maxSteps = parseInt(document.getElementById('maxSteps').value);
            const epsilon = parseFloat(document.getElementById('epsilon').value);
            const renderFPS = parseInt(document.getElementById('renderFPS').value);

            log(`Starting training: ${numEpisodes} episodes, max ${maxSteps} steps, epsilon=${epsilon}`, 'info');
            updateStatus('Training in progress...', 'training');

            for (let i = 0; i < numEpisodes && isTraining; i++) {
                const result = await runEpisode(totalEpisodes + 1, maxSteps, epsilon, renderFPS);

                episodes.push(result);
                totalEpisodes++;

                // Update statistics
                updateStatistics();
                updateChart();

                log(`Episode ${result.episode}: Reward=${result.reward}, Steps=${result.steps}`,
                    result.reward > 0 ? 'success' : 'info');

                // Yield to browser
                await new Promise(resolve => setTimeout(resolve, 0));
            }

            if (isTraining) {
                updateStatus('Training completed!', 'success');
                log('Training completed successfully', 'success');
            } else {
                updateStatus('Training stopped by user', 'warning');
                log('Training stopped by user', 'warning');
            }

            stopTraining();
        }

        // Update statistics
        function updateStatistics() {
            const recentEpisodes = episodes.slice(-100); // Last 100 episodes

            const totalReward = recentEpisodes.reduce((sum, ep) => sum + ep.reward, 0);
            const totalSteps = recentEpisodes.reduce((sum, ep) => sum + ep.steps, 0);
            const maxReward = Math.max(...episodes.map(ep => ep.reward));

            document.getElementById('totalEpisodes').textContent = totalEpisodes;
            document.getElementById('avgReward').textContent = (totalReward / recentEpisodes.length).toFixed(1);
            document.getElementById('maxReward').textContent = maxReward;
            document.getElementById('avgSteps').textContent = Math.round(totalSteps / recentEpisodes.length);
        }

        // Update chart
        function updateChart() {
            const width = chartCanvas.width = chartCanvas.offsetWidth;
            const height = chartCanvas.height = chartCanvas.offsetHeight;

            chartCtx.clearRect(0, 0, width, height);

            if (episodes.length < 2) return;

            // Get data to plot (last 100 episodes)
            const dataToPlot = episodes.slice(-100);
            const maxReward = Math.max(...dataToPlot.map(ep => ep.reward), 1);
            const minReward = Math.min(...dataToPlot.map(ep => ep.reward), 0);
            const range = maxReward - minReward || 1;

            // Draw axes
            chartCtx.strokeStyle = '#30363d';
            chartCtx.lineWidth = 1;
            chartCtx.beginPath();
            chartCtx.moveTo(40, 10);
            chartCtx.lineTo(40, height - 30);
            chartCtx.lineTo(width - 10, height - 30);
            chartCtx.stroke();

            // Draw grid
            chartCtx.strokeStyle = '#21262d';
            for (let i = 0; i < 5; i++) {
                const y = 10 + (height - 40) * i / 4;
                chartCtx.beginPath();
                chartCtx.moveTo(40, y);
                chartCtx.lineTo(width - 10, y);
                chartCtx.stroke();
            }

            // Draw labels
            chartCtx.fillStyle = '#8b949e';
            chartCtx.font = '10px monospace';
            chartCtx.textAlign = 'right';
            chartCtx.fillText(maxReward.toFixed(0), 35, 15);
            chartCtx.fillText(minReward.toFixed(0), 35, height - 25);
            chartCtx.fillText('0', 35, height - 30 - (0 - minReward) / range * (height - 40));

            // Draw reward line
            chartCtx.strokeStyle = '#58a6ff';
            chartCtx.lineWidth = 2;
            chartCtx.beginPath();

            const xStep = (width - 50) / (dataToPlot.length - 1);
            dataToPlot.forEach((ep, i) => {
                const x = 40 + i * xStep;
                const y = height - 30 - ((ep.reward - minReward) / range) * (height - 40);

                if (i === 0) {
                    chartCtx.moveTo(x, y);
                } else {
                    chartCtx.lineTo(x, y);
                }
            });
            chartCtx.stroke();

            // Draw moving average
            if (dataToPlot.length > 10) {
                chartCtx.strokeStyle = '#3fb950';
                chartCtx.lineWidth = 2;
                chartCtx.beginPath();

                for (let i = 9; i < dataToPlot.length; i++) {
                    const avgReward = dataToPlot.slice(i - 9, i + 1).reduce((sum, ep) => sum + ep.reward, 0) / 10;
                    const x = 40 + i * xStep;
                    const y = height - 30 - ((avgReward - minReward) / range) * (height - 40);

                    if (i === 9) {
                        chartCtx.moveTo(x, y);
                    } else {
                        chartCtx.lineTo(x, y);
                    }
                }
                chartCtx.stroke();
            }

            // Legend
            chartCtx.font = '11px sans-serif';
            chartCtx.fillStyle = '#58a6ff';
            chartCtx.fillText('Episode Reward', width - 150, 20);
            chartCtx.fillStyle = '#3fb950';
            chartCtx.fillText('Moving Avg (10)', width - 150, 35);
        }

        // Control functions
        function startTraining() {
            isTraining = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('numEpisodes').disabled = true;
            document.getElementById('maxSteps').disabled = true;
            document.getElementById('epsilon').disabled = true;
            trainLoop();
        }

        function stopTraining() {
            isTraining = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('numEpisodes').disabled = false;
            document.getElementById('maxSteps').disabled = false;
            document.getElementById('epsilon').disabled = false;
        }

        function resetStats() {
            episodes = [];
            totalEpisodes = 0;
            currentEpisodeData = { episode: 0, reward: 0, steps: 0 };

            document.getElementById('totalEpisodes').textContent = '0';
            document.getElementById('avgReward').textContent = '0.0';
            document.getElementById('maxReward').textContent = '0';
            document.getElementById('avgSteps').textContent = '0';
            document.getElementById('currentEpisode').textContent = '0';
            document.getElementById('currentSteps').textContent = '0';
            document.getElementById('currentReward').textContent = '0';

            chartCtx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            logContainer.innerHTML = '';

            log('Statistics reset', 'info');
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startTraining);
        document.getElementById('stopBtn').addEventListener('click', stopTraining);
        document.getElementById('resetBtn').addEventListener('click', resetStats);

        // Initialize
        initALE();
    </script>
</body>
</html>
