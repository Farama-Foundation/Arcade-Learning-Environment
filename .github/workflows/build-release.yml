# workflow on publish
# 1. build the wheels for linux intel / arm, macos arm and windows
# 2. download artifacts and upload to PyPI
# 3. build WASM and create NPM package and standalone bundle
# 4. upload WASM standalone bundle to GitHub release and publish NPM package (if NPM_TOKEN is available)

name: Build and publish releases

on:
  release:
    types: [ published ]

jobs:
  build-wheels:
    name: "${{ matrix.runs-on }} â€¢ ${{ matrix.arch }}"
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        include:
          - runs-on: ubuntu-latest
            arch: x86_64
          - runs-on: ubuntu-24.04-arm
            arch: aarch64
          - runs-on: windows-latest
            arch: AMD64
          - runs-on: macos-13
            arch: arm64
    runs-on: ${{ matrix.runs-on }}

    steps:
    - uses: actions/checkout@v6

    - name: Set up Docker Buildx
      if: runner.os == 'linux'
      id: buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true

    - name: Build Docker image with vcpkg
      if: runner.os == 'linux'
      # using build-push-action (without push) to make use of cache arguments
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ".github/docker/manylinux-${{ matrix.arch }}-vcpkg.Dockerfile"
        tags: "manylinux-${{ matrix.arch }}-vcpkg:latest"
        push: false
        load: true

    - name: Download and unpack ROMs
      run: ./scripts/download_unpack_roms.sh

    - name: Build wheels
      uses: pypa/cibuildwheel@v3.0
      env:
        CIBW_ARCHS: "${{ matrix.arch }}"

    - name: Upload wheels
      uses: actions/upload-artifact@v5
      with:
        name: wheels-${{ matrix.runs-on }}-${{ matrix.arch }}
        path: ./wheelhouse/*.whl

  push-pypi:
    name: Deploy wheels to PyPi
    runs-on: ubuntu-latest
    needs: build-wheels
    permissions:
      id-token: write

    steps:
      # create the `ale_py-*.*.*.tar.gz` for source building
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - run: pip install setuptools
      - run: python setup.py sdist

      - uses: actions/download-artifact@v6
        with:
          name: wheels-windows-latest-AMD64
          path: dist

      - uses: actions/download-artifact@v6
        with:
          name: wheels-ubuntu-latest-x86_64
          path: dist

      - uses: actions/download-artifact@v6
        with:
          name: wheels-ubuntu-24.04-arm-aarch64
          path: dist

      - uses: actions/download-artifact@v6
        with:
          name: wheels-macos-13-arm64
          path: dist

      - run: ls dist/

      - name: Upload wheels to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.wheel

      - name: Publish to PyPi test
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
          packages-dir: dist/
          print-hash: true

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.68'
          actions-cache-folder: 'emsdk-cache'

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=$GITHUB_WORKSPACE/vcpkg" >> $GITHUB_ENV

      - name: Install vcpkg dependencies
        run: |
          $VCPKG_ROOT/vcpkg install zlib:wasm32-emscripten \
            --overlay-triplets=cmake/custom-triplets

      - name: Download and unpack ROMs
        run: ./scripts/download_unpack_roms.sh

      - name: Build and package WASM
        run: ./scripts/package-wasm.sh
        env:
          EMSDK_PATH: ${{ env.EMSDK }}

      - name: Upload standalone bundle to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip

      - name: Upload NPM package artifact
        uses: actions/upload-artifact@v5
        with:
          name: npm-package
          path: dist/npm/

#  push-npm:
#    name: Publish to NPM
#    runs-on: ubuntu-latest
#    needs: build-wasm
#    # Only publish to NPM if token is available
#    if: ${{ secrets.NPM_TOKEN != '' }}
#
#    steps:
#      - uses: actions/download-artifact@v6
#        with:
#          name: npm-package
#          path: dist/npm/
#
#      - name: Setup Node.js
#        uses: actions/setup-node@v4
#        with:
#          node-version: '20'
#          registry-url: 'https://registry.npmjs.org'
#
#      - name: Publish to NPM
#        run: |
#          cd dist/npm
#          npm publish --access public
#        env:
#          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
